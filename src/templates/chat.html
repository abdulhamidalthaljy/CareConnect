{% extends 'layout.html' %} {% block content %}
<div class="container mx-auto mt-6" data-user-id="{{ current_user.id }}">
  <h1 class="text-2xl font-bold mb-4">Secure Chat</h1>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="bg-white shadow rounded p-4">
      <h2 class="font-semibold mb-2">Contacts</h2>
      <ul id="contacts-list" class="divide-y">
        {% for c in contacts %}
        <li class="py-2 cursor-pointer contact-item" data-id="{{ c.id }}">
          {{ c.username }}
        </li>
        {% else %}
        <li>No contacts</li>
        {% endfor %}
      </ul>
    </div>

    <div class="md:col-span-2 bg-white shadow rounded p-4">
      <h2 class="font-semibold mb-2">Messages</h2>
      <div id="messages" class="h-96 overflow-y-auto border p-2 mb-3"></div>

      <form id="msg-form" class="flex space-x-2">
        <input
          id="msg-input"
          class="flex-1 border p-2"
          placeholder="Type a message..."
        />
        <button type="submit" class="bg-blue-500 text-white px-3 py-1 rounded">
          Send
        </button>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
  const socket = io();
  let selectedContactId = null;
  const currentUserId = (function(){
    const v = document.querySelector('.container').dataset.userId;
    return v ? parseInt(v, 10) : null;
  })();

  function appendMessage(m) {
    const container = document.getElementById('messages');
    const div = document.createElement('div');
    const time = new Date(m.timestamp).toLocaleString();
    div.innerHTML = `<div class="mb-2"><strong>${m.from==currentUserId ? 'You' : 'Them'}</strong> <span class="text-sm text-gray-500">${time}</span><div>${m.text}</div></div>`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  document.querySelectorAll('.contact-item').forEach(el => {
    el.addEventListener('click', () => {
      document.querySelectorAll('.contact-item').forEach(x => x.classList.remove('bg-gray-100'));
      el.classList.add('bg-gray-100');
      selectedContactId = el.dataset.id;
      // load history
      fetch(`/api/get_messages/${selectedContactId}`)
        .then(r => r.json())
        .then(data => {
          const container = document.getElementById('messages');
          container.innerHTML = '';
          data.forEach(m => appendMessage(m));
        })
        .catch(err => console.error('Failed loading messages', err));
    });
  });

  socket.on('connect', () => {
    console.log('socket connected');
  });

  socket.on('new_message', (m) => {
    // if message belongs to current conversation, show it
    if (!selectedContactId) return; // ignore until a contact is selected
    if (m.from == selectedContactId || m.to == selectedContactId) {
      appendMessage(m);
    }
  });

  document.getElementById('msg-form').addEventListener('submit', (ev) => {
    ev.preventDefault();
    const text = document.getElementById('msg-input').value.trim();
    if (!text || !selectedContactId) return;
    socket.emit('private_message', { to_user_id: parseInt(selectedContactId), message: text });
    document.getElementById('msg-input').value = '';
  });
</script>

{% endblock %}
