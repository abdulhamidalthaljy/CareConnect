{% extends 'layout.html' %} {% block title %}Patient - {{ patient.username }}{%
endblock %} {% block content %}
<div class="space-y-6">
  <header class="bg-white rounded-lg shadow p-6">
    <h1 class="text-2xl font-semibold">Patient: {{ patient.username }}</h1>
    <p class="text-sm text-gray-600 mt-1">
      View and manage patient profile and health data.
    </p>
  </header>

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %} {% if
  messages %}
  <div class="space-y-2">
    {% for category, message in messages %}
    <div
      class="p-3 rounded-md {{ 'bg-green-100 text-green-800' if category == 'success' else 'bg-red-100 text-red-800' if category == 'danger' else 'bg-blue-100 text-blue-800' }}"
    >
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %} {% endwith %}

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 space-y-6">
      <!-- Editable Profile Section -->
      <section class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-medium mb-3">Profile</h2>
        <form
          action="{{ url_for('doctor.update_patient_profile', patient_id=patient.id) }}"
          method="POST"
          class="space-y-4"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Full name</label
              >
              <input
                type="text"
                name="full_name"
                class="mt-1 block w-full border rounded-md p-2"
                value="{{ profile.full_name if profile else '' }}"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Address</label
              >
              <input
                type="text"
                name="address"
                class="mt-1 block w-full border rounded-md p-2"
                value="{{ profile.address if profile else '' }}"
              />
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Allergies</label
            >
            <input
              type="text"
              name="allergies"
              class="mt-1 block w-full border rounded-md p-2"
              value="{{ profile.allergies if profile else '' }}"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Health history</label
            >
            <textarea
              name="health_history"
              class="mt-1 block w-full border rounded-md p-2"
              rows="3"
            >
{{ profile.health_history if profile else '' }}</textarea
            >
          </div>
          <button
            type="submit"
            class="bg-green-600 text-white px-4 py-2 rounded-md"
          >
            Save Profile
          </button>
        </form>
      </section>

      <!-- Medicines Section with Add/Delete -->
      <section class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-medium mb-3">Medicines</h2>

        <!-- Add Medicine Form -->
        <form
          action="{{ url_for('doctor.add_patient_medicine', patient_id=patient.id) }}"
          method="POST"
          class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-4"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <input
            type="text"
            name="name"
            placeholder="Medicine name"
            class="border p-2 rounded-md"
            required
          />
          <input
            type="text"
            name="dosage"
            placeholder="Dosage (e.g. 500mg)"
            class="border p-2 rounded-md"
          />
          <button
            type="submit"
            class="bg-blue-600 text-white px-3 py-2 rounded-md"
          >
            Add Medicine
          </button>
        </form>

        <!-- Medicines List -->
        <div class="overflow-x-auto">
          <table class="w-full table-auto text-sm">
            <thead>
              <tr class="text-left text-gray-600">
                <th class="px-2 py-2">Name</th>
                <th class="px-2 py-2">Dosage</th>
                <th class="px-2 py-2">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for m in medicines %}
              <tr class="border-t">
                <td class="px-2 py-2">{{ m.name }}</td>
                <td class="px-2 py-2">{{ m.dosage }}</td>
                <td class="px-2 py-2">
                  <form
                    action="{{ url_for('doctor.delete_patient_medicine', med_id=m.id) }}"
                    method="POST"
                    style="display: inline"
                  >
                    <input
                      type="hidden"
                      name="csrf_token"
                      value="{{ csrf_token() }}"
                    />
                    <button type="submit" class="text-red-600 hover:underline">
                      Delete
                    </button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="3" class="px-2 py-2 text-gray-500">
                  No medicines recorded.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <!-- Vitals Section with Add/Delete -->
      <section class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-medium mb-3">Vitals</h2>

        <!-- Add Vital Form -->
        <form
          action="{{ url_for('doctor.add_patient_vital', patient_id=patient.id) }}"
          method="POST"
          class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <select name="type" class="border p-2 rounded-md">
            <option value="bp">Blood Pressure</option>
            <option value="sugar">Blood Sugar</option>
          </select>
          <input
            type="text"
            name="value1"
            placeholder="Value 1 (e.g. 120)"
            class="border p-2 rounded-md"
            required
          />
          <input
            type="text"
            name="value2"
            placeholder="Value 2 (e.g. 80)"
            class="border p-2 rounded-md"
          />
          <button
            type="submit"
            class="bg-blue-600 text-white px-3 py-2 rounded-md"
          >
            Add Vital
          </button>
        </form>

        <!-- Vitals Chart -->
        <canvas
          id="patientVitalsChart"
          width="600"
          height="200"
          class="mb-4"
        ></canvas>

        <!-- Vitals List -->
        <div class="overflow-x-auto max-h-64 overflow-y-auto">
          <table class="w-full table-auto text-sm">
            <thead class="sticky top-0 bg-white">
              <tr class="text-left text-gray-600">
                <th class="px-2 py-2">Type</th>
                <th class="px-2 py-2">Value 1</th>
                <th class="px-2 py-2">Value 2</th>
                <th class="px-2 py-2">Date</th>
                <th class="px-2 py-2">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for v in vitals %}
              <tr class="border-t">
                <td class="px-2 py-2">
                  {{ 'Blood Pressure' if v.type == 'bp' else 'Blood Sugar' }}
                </td>
                <td class="px-2 py-2">{{ v.value1 }}</td>
                <td class="px-2 py-2">{{ v.value2 or '-' }}</td>
                <td class="px-2 py-2">
                  {{ v.timestamp.strftime('%Y-%m-%d %H:%M') }}
                </td>
                <td class="px-2 py-2">
                  <form
                    action="{{ url_for('doctor.delete_patient_vital', vital_id=v.id) }}"
                    method="POST"
                    style="display: inline"
                  >
                    <input
                      type="hidden"
                      name="csrf_token"
                      value="{{ csrf_token() }}"
                    />
                    <button type="submit" class="text-red-600 hover:underline">
                      Delete
                    </button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="5" class="px-2 py-2 text-gray-500">
                  No vitals recorded.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <!-- Files Section -->
      <section class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-medium mb-3">Files</h2>
        <ul class="text-sm">
          {% for f in files %}
          <li class="mb-1">
            <a
              class="text-blue-600 hover:underline"
              href="{{ url_for('main.download_file', file_id=f.id) }}"
            >
              {{ f.original_filename }}
            </a>
            <span class="text-gray-500 text-xs ml-2"
              >{{ f.upload_timestamp.strftime('%Y-%m-%d') }}</span
            >
          </li>
          {% else %}
          <li class="text-gray-500">No files uploaded.</li>
          {% endfor %}
        </ul>
      </section>

      <!-- Export Section -->
      <section class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-medium mb-3">Export Patient Data</h2>
        <div class="flex space-x-2">
          <a
            href="{{ url_for('main.export_excel', patient_id=patient.id) }}"
            class="bg-gray-800 text-white px-4 py-2 rounded-md hover:bg-gray-700"
            >Excel</a
          >
          <a
            href="{{ url_for('main.export_pdf', patient_id=patient.id) }}"
            class="bg-gray-700 text-white px-4 py-2 rounded-md hover:bg-gray-600"
            >PDF</a
          >
        </div>
      </section>
    </div>

    <!-- Sidebar with quick stats -->
    <aside class="space-y-6">
      <section class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-medium mb-3">Quick Stats</h3>
        <div class="space-y-3 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-600">Medicines:</span>
            <span class="font-medium">{{ medicines|length }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Vitals recorded:</span>
            <span class="font-medium">{{ vitals|length }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Files uploaded:</span>
            <span class="font-medium">{{ files|length }}</span>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-medium mb-3">Actions</h3>
        <div class="space-y-2">
          <a
            href="{{ url_for('doctor.dashboard') }}"
            class="block text-center bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300"
          >
            ‚Üê Back to Patients
          </a>
          <a
            href="{{ url_for('chat.chat_page') }}"
            class="block text-center bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"
          >
            Chat with Patient
          </a>
        </div>
      </section>
    </aside>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  fetch("/api/get_vitals?patient_id={{ patient.id }}")
    .then((r) => r.json())
    .then((data) => {
      const labels = data.map((v) => new Date(v.timestamp).toLocaleString());
      const systolic = data.map((v) =>
        v.type === "bp" ? parseFloat(v.value1) || null : null
      );
      const diastolic = data.map((v) =>
        v.type === "bp" ? (v.value2 ? parseFloat(v.value2) : null) : null
      );
      const sugar = data.map((v) =>
        v.type === "sugar" ? parseFloat(v.value1) || null : null
      );

      const datasets = [];
      if (systolic.some((x) => x !== null))
        datasets.push({
          label: "Systolic",
          data: systolic,
          borderColor: "rgba(220,38,38,1)",
          backgroundColor: "rgba(220,38,38,0.1)",
        });
      if (diastolic.some((x) => x !== null))
        datasets.push({
          label: "Diastolic",
          data: diastolic,
          borderColor: "rgba(34,197,94,1)",
          backgroundColor: "rgba(34,197,94,0.1)",
        });
      if (sugar.some((x) => x !== null))
        datasets.push({
          label: "Blood Sugar",
          data: sugar,
          borderColor: "rgba(59,130,246,1)",
          backgroundColor: "rgba(59,130,246,0.1)",
        });
      if (datasets.length === 0)
        datasets.push({
          label: "Values",
          data: data.map((v) => parseFloat(v.value1) || 0),
          borderColor: "rgba(59,130,246,1)",
          backgroundColor: "rgba(59,130,246,0.1)",
        });

      const ctx = document.getElementById("patientVitalsChart");
      new Chart(ctx, {
        type: "line",
        data: { labels: labels, datasets: datasets },
        options: { responsive: true },
      });
    })
    .catch((err) => console.error("Error loading patient vitals", err));
</script>
{% endblock %}
